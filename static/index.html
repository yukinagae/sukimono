<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>SUKIMONO</title>
	<link rel="stylesheet" type="text/css" href="css/sukimono.css">
	<link href='http://fonts.googleapis.com/css?family=Shadows+Into+Light' rel='stylesheet' type='text/css'>
</head>
<body>
	<div class="sidebar">
		<h1 class="title">SUKIMONO</h1>
		<form data-bind="submit: saveNote">
			<ul>
				<li>Id</li>
				<li>
					<input data-bind="value: newNote().id" style="width: 6rem;"/>
				</li>
				<li>UUID</li>
				<span data-bind="text: newNote().uuid"></span>
				<li>Name</li>
				<li>
					<input data-bind="value: newNote().name" style="width: 24rem;"/>
				</li>
				<li>Content</li>
				<li>
					<textarea data-bind="value: newNote().content" style="width: 24rem; height: 8rem;"></textarea>
				</li>
				<li>Tags</li>
				<li>
					<div data-bind="foreach: newNote().tags">
						<span class="tag" data-bind="text: $data, click: $parent.removeTag"></span>
					</div>

				</li>
			</ul>

			<button type="submit">Save</button>
		</form>

		<div>
			<h3>Tags can be added</h3>
			<div data-bind="foreach: tags">
				<span class="tag" data-bind="text: $data, click: $parent.addTag"></span>
			</div>
			<form data-bind="submit: addCustomTag">
    			<input data-bind='value: newCustomTag, valueUpdate: "afterkeydown"' />
			</form>
		</div>
	</div>
	
	<div class="content" data-bind="foreach: notes">
		<div class="note" data-bind="click: $data.edit">
			<h4 data-bind="text: $data.name"></h4>
			<span data-bind="text: $data.created"></span>
			<span data-bind="text: $data.uuid"></span>
			<hr/>
			<pre data-bind="text: $data.content"></pre>
			<div data-bind="foreach: $data.tags">
				<span class="tag" data-bind="text: $data"></span>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="js/knockout-3.2.0.js"></script>
	<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript">

		var Model = Model || {};

		Model = {
			fn : {
				NoteModels : function() {
					var self = this;
					self.notes = ko.observableArray();
					self.newNote = ko.observable(new Model.fn.NoteModel({}));
					self.tags = ko.observableArray();
					self.newCustomTag = ko.observable("");
					self.saveNote = function() {
						$.post("/api/save", ko.toJSON(self.newNote()), function(data) {
							var n = new Model.fn.NoteModel({});
							n.id(data.id || '');
							n.uuid(data.uuid || '');
							n.name(data.name || '');
							n.content(data.content || '');
							n.tags(data.tags || []);
							n.created(data.created || '');
							Model.va.vmodel.notes.push(n);
						});
					}
					self.removeTag = function(tag) {
						self.newNote().tags.remove(tag);
					}
					self.addTag = function(tag) {
						console.log(tag);
						self.newNote().tags.push(tag);
					}
					self.addCustomTag = function() {
						console.log(self.newCustomTag());
						self.tags.push(self.newCustomTag());
					}
				},
				NoteModel : function(data) {
					var self = this;
					self.id = ko.observable(data.id || '');
					self.uuid = ko.observable(data.uuid || '');
					self.name = ko.observable(data.name || '');
					self.content = ko.observable(data.content || '');
					self.tags = ko.observableArray(data.tags || []);
					self.created =  ko.observable(data.created || '');
					self.edit = function(note) {
						Model.va.vmodel.newNote(note);
					}
				},
				allList : function() {
					$.getJSON("/api/list", function (data) {
						data.forEach(function (row) {
							var note = new Model.fn.NoteModel(row);
							Model.va.vmodel.notes.push(note);
							Model.va.vmodel.tags.push(row.tags);
						});
					});
				}
			},
			va : {
				vmodel : null
			}
		}

		$(function() {
			Model.va.vmodel = new Model.fn.NoteModels();
			ko.applyBindings(Model.va.vmodel);
			Model.fn.allList();
		});

	</script>
</body>
</html>
